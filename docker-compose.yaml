version: '3.4'

x-common-env-variables: &common-env-variables
  NODE_ENV: production-docker

services:
  teslo-shop:
    image: rodarte/nestjs-fr-teslo-shop-prod:3a19300
    ports:
      - '3000:3000'
    secrets:
      - teslo_shop_postgres_url
    environment:
      <<: *common-env-variables
      PORT: 3000
      POSTGRES_URL_FILE: /run/secrets/teslo_shop_postgres_url
    depends_on:
      - teslo-shop-postgres
  teslo-shop-postgres:
    image: postgres:14.3
    secrets:
      - teslo_shop_postgres_password
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD_FILE: /run/secrets/teslo_shop_postgres_password
      POSTGRES_DB: nestjs-teslo-shop
    volumes:
      - ./teslo-shop/postgres/prod:/var/lib/postgresql/data

secrets:
  teslo_shop_postgres_url:
    file: ./secrets/docker/teslo-shop/postgres-url.txt
  teslo_shop_postgres_password:
    file: ./secrets/docker/teslo-shop-postgres/postgres-password.txt
